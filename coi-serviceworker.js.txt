// coi-serviceworker.js
// 1ファイルで登録＋本体。ページから読み込まれると自分自身をSWとして登録し、
// Service WorkerコンテキストではCOOP/COEPヘッダを付けて返す。

(function () {
  const swUrl = 'coi-serviceworker.js';

  // ---- ページ側（Window）: 自分自身を登録 ----
  if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
    // すでに登録済みでもOK（新しい内容に更新されます）
    navigator.serviceWorker.register(swUrl, { scope: './' }).catch(() => {});
  }

  // ---- SW側（Worker）: COOP/COEP付与 ----
  if (typeof self !== 'undefined' && self instanceof ServiceWorkerGlobalScope) {
    self.addEventListener('install', () => self.skipWaiting());
    self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));

    self.addEventListener('fetch', (event) => {
      const req = event.request;

      // Chromeのonly-if-cachedバグ回避
      if (req.cache === 'only-if-cached' && req.mode !== 'same-origin') return;

      event.respondWith(
        fetch(req)
          .then((res) => {
            const headers = new Headers(res.headers);
            headers.set('Cross-Origin-Opener-Policy', 'same-origin');
            headers.set('Cross-Origin-Embedder-Policy', 'require-corp');
            return new Response(res.body, {
              status: res.status,
              statusText: res.statusText,
              headers,
            });
          })
          .catch(() => fetch(req))
      );
    });
  }
})();
